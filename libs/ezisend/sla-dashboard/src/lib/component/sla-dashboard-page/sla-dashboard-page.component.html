<div class="container-page" #dashboardContainer>
  <div class="main-title">{{ languageData.perfomance_insights }}</div>
  <div class="container-card">
    <div class="header-sla">

      <div class="header-filter">
        <div class="date-picker-container">
          <form [formGroup]="dateRangePickerForm" class="date-picker-form">
            <pos-date-range-picker
              (formChange)="onDateRangePickerFormChange($event)"
              class="px-3"
            ></pos-date-range-picker>
          </form>
          <label>{{ languageData.last_refreshed }}: {{ updatedLastRefreshed }}</label>
        </div>
        <div class="button-download">
          <button
            mat-flat-button
            color="primary"
            [matMenuTriggerFor]="headerMenu"
           
          >
            {{ languageData.download_all }}
            <mat-icon class="material-icon-outlined" mat-icon-button>
              arrow_drop_down
            </mat-icon>
          </button>
          <mat-menu #headerMenu="matMenu">
            <button mat-menu-item (click)="downloadFile('sla_all')">
              {{ languageData.report }} (.xlsx)
            </button>
            <button mat-menu-item (click)="downloadAllAsPDF()">
              {{ languageData.report }} (.pdf)
            </button>
          </mat-menu>
        </div>
      </div>
    </div>

    <div class="container rto">
      <div class="rto-layout">
        <div class="spinner-container" *ngIf="isRtoLoading">
          <mat-spinner class="spinner"></mat-spinner>
        </div>

        <div class="rto-cards" *ngIf="!isRtoLoading">
          <div
            class="rto-card"
            *ngFor="let item of rtoData"
            [ngClass]="'theme-' + item.theme"
          >
            <div class="rto-card-content">
              <div class="rto-icon">
                <mat-icon>{{ item.icon }}</mat-icon>
              </div>
              <div class="rto-info">
                <div class="rto-label">{{ item.label }}</div>
                <div class="rto-price">{{ item.price }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex-container">
      <div class="container">
        <div class="title-container">
          <span>{{ languageData.shipment_status }}</span>
          <a
            color="primary"
            [matMenuTriggerFor]="statusSummaryMenu"
            *ngIf="!isStatusSummaryEmpty"
            href="#"
            class="download-link"
            (click)="$event.preventDefault()"
          >
            {{ languageData.download_as }}
            <mat-icon class="material-icon-outlined" mat-icon-button>
              arrow_drop_down
            </mat-icon>
          </a>
          <mat-menu #statusSummaryMenu="matMenu">
            <button mat-menu-item (click)="downloadFile('sla_shipment_status')">
              {{ languageData.report }} (.xlsx)
            </button>
            <button
              mat-menu-item
              (click)="downloadChartAsPDF('status_summary')"
            >
              {{ languageData.report }} (.pdf)
            </button>
          </mat-menu>
        </div>
        <div class="chart-card" #statusSummaryChart>
          <div
            class="spinner-container spinner-pie"
            *ngIf="isStatusSummaryLoading"
          >
            <mat-spinner class="spinner"></mat-spinner>
          </div>

          <canvas
            baseChart
            [data]="getFilteredStatusSummaryChartData()"
            [labels]="getFilteredStatusSummaryLabels()"
            [chartType]="'doughnut'"
            [options]="statusSummaryChartOptions"
            [colors]="statusSummaryChartColors"
            [legend]="true"
            [plugins]="statusSummaryChartPlugins"
            *ngIf="
              !isStatusSummaryEmpty &&
              !isStatusSummaryLoading &&
              hasStatusSummaryData()
            "
          >
          </canvas>

          <div
            class="no-data"
            *ngIf="isStatusSummaryEmpty && !isStatusSummaryLoading"
          >
            {{ languageData.no_data }}
          </div>
        </div>
      </div>

      <div class="container">
        <div class="title-container">
          <span>{{ languageData.delivery_status }}</span>
          <a
            color="primary"
            [matMenuTriggerFor]="statusMenu"
            *ngIf="!isStatusEmpty"
            href="#"
            class="download-link"
            (click)="$event.preventDefault()"
          >
            {{ languageData.download_as }}
            <mat-icon class="material-icon-outlined" mat-icon-button>
              arrow_drop_down
            </mat-icon>
          </a>
          <mat-menu #statusMenu="matMenu">
            <button mat-menu-item (click)="downloadFile('sla_status')">
              {{ languageData.report }} (.xlsx)
            </button>
            <button mat-menu-item (click)="downloadChartAsPDF('status')">
              {{ languageData.report }} (.pdf)
            </button>
          </mat-menu>
        </div>
        <div class="chart-card" #statusChart>
          <div class="spinner-container spinner-pie" *ngIf="isStatusLoading">
            <mat-spinner class="spinner"></mat-spinner>
          </div>

          <canvas
            baseChart
            [datasets]="statusPieData"
            [labels]="statusPieLabels"
            [options]="statusPieOptions"
            [legend]="true"
            [chartType]="'doughnut'"
            [plugins]="statusPiePlugins"
            *ngIf="!isStatusEmpty && !isStatusLoading"
          >
          </canvas>

          <div class="no-data" *ngIf="isStatusEmpty && !isStatusLoading">
            {{ languageData.no_data }}
          </div>
        </div>
      </div>
    </div>

    <div class="flex-container">
      <div class="container">
        <div class="title-container">
          <span>{{ languageData.delivery_status_by_days }}</span>
          <a
            color="primary"
            [matMenuTriggerFor]="categoryMenu"
            *ngIf="!isEmptyType"
            href="#"
            class="download-link"
            (click)="$event.preventDefault()"
          >
            {{ languageData.download_as }}
            <mat-icon class="material-icon-outlined" mat-icon-button>
              arrow_drop_down
            </mat-icon>
          </a>
          <mat-menu #categoryMenu="matMenu">
            <button mat-menu-item (click)="downloadFile('sla_category')">
              {{ languageData.report }} (.xlsx)
            </button>
            <button mat-menu-item (click)="downloadChartAsPDF('category')">
              {{ languageData.report }} (.pdf)
            </button>
          </mat-menu>
        </div>
        <div class="chart-card" #categoryChart>
          <div class="spinner-container spinner-bar" *ngIf="isCategoryLoading">
            <mat-spinner class="spinner"></mat-spinner>
          </div>

          <canvas
            baseChart
            [datasets]="catBarData"
            [labels]="catBarLabels"
            [options]="catBarOptions"
            [legend]="catBarLegend"
            [chartType]="catBarType"
            [plugins]="catBarPlugins"
            *ngIf="!isEmptyType && !isCategoryLoading"
          >
          </canvas>

          <div class="no-data" *ngIf="isEmptyType && !isCategoryLoading">
            <p>{{ languageData.no_available_data }}</p>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="title-container">
          <span>{{ languageData.delivery_status_by_destination }}</span>
          <a
            color="primary"
            [matMenuTriggerFor]="stateMenu"
            *ngIf="shipmentData.length > 0"
            href="#"
            class="download-link"
            (click)="$event.preventDefault()"
          >
            {{ languageData.download_as }}
            <mat-icon class="material-icon-outlined" mat-icon-button>
              arrow_drop_down
            </mat-icon>
          </a>
          <mat-menu #stateMenu="matMenu">
            <button mat-menu-item (click)="downloadFile('sla_state')">
              {{ languageData.report }} (.xlsx)
            </button>
            <button mat-menu-item (click)="downloadChartAsPDF('state')">
              {{ languageData.report }} (.pdf)
            </button>
          </mat-menu>
        </div>

        <div class="shipment-chart" #stateChart *ngIf="shipmentData.length > 0">
          <div class="spinner-container spinner-state" *ngIf="isStateLoading">
            <mat-spinner class="spinner"></mat-spinner>
          </div>

          <div class="sla-bar-header-row" *ngIf="!isStateLoading">
            <div class="sla-bar-header-percentage">
              {{ languageData.delivery_status_by_percentage }}
            </div>
            <div class="sla-bar-header-volume">{{ languageData.delivery_status_by_volume }}</div>
          </div>

          <ng-container *ngIf="shipmentData.length > 0 && !isStateLoading">
            <div class="sla-bar-row" *ngFor="let item of shipmentData">
              <!-- State Name Label -->
              <div class="sla-bar-label">{{ item.state }}</div>

              <!-- SLA Percentage Bar (with custom tooltip) -->
              <div
                class="sla-bar-percentage-container custom-tooltip-container"
              >
                <div
                  class="sla-bar-percentage"
                  [ngStyle]="{
                    'width.%': item.percentage,
                    'background-color':
                      item.percentage >= 90
                        ? '#72f285'
                        : item.percentage >= 80
                        ? '#f2b572'
                        : '#f25c5c',
                    'margin-left': '12px',
                    'margin-right': '12px'
                  }"
                >
                  <span class="sla-bar-percentage-text"
                    >{{ truncateDecimal(item.percentage, 1) }}%</span
                  >
                </div>
                <div class="sla-bar-tooltip">
                  <div class="sla-bar-tooltip-label">{{ languageData.success }} %:</div>
                  <div class="sla-bar-tooltip-value">
                    {{ truncateDecimal(item.percentage, 2) }}%
                  </div>
                </div>
              </div>

              <!-- Shipment Volume Bar with Volume Label on the Left -->
              <div class="sla-bar-volume-container">
                <div
                  class="sla-bar-volume"
                  [ngStyle]="{
                    'width.%': getShipmentBarWidth(item.shipments)
                  }"
                ></div>
                <div class="sla-bar-volume-label-group">
                  <span class="sla-bar-volume-label">{{
                    item.shipments | number
                  }}</span>
                </div>
              </div>
            </div>
          </ng-container>
          <div
            class="total-shipment"
            *ngIf="shipmentData.length > 0 && !isStateLoading"
          >
            {{ languageData.total_shipments }}: <strong>{{ getTotalShipments() | number }}</strong>
          </div>
        </div>

        <div
          class="no-data"
          *ngIf="shipmentData.length === 0 && !isStateLoading"
        >
          {{ languageData.no_data }}
        </div>
      </div>
    </div>

    <div class="flex-container">
      <div class="container">
        <div class="title-container">
          <span>{{ languageData.delivery_exceptions }}</span>
          <a
            color="primary"
            [matMenuTriggerFor]="dexMenu"
            *ngIf="!isEmptyDex"
            href="#"
            class="download-link"
            (click)="$event.preventDefault()"
          >
            {{ languageData.download_as }}
            <mat-icon class="material-icon-outlined" mat-icon-button>
              arrow_drop_down
            </mat-icon>
          </a>
          <mat-menu #dexMenu="matMenu">
            <button mat-menu-item (click)="downloadFile('sla_dex')">
              {{ languageData.report }} (.xlsx)
            </button>
            <button mat-menu-item (click)="downloadChartAsPDF('dex')">
              {{ languageData.report }} (.pdf)
            </button>
          </mat-menu>
        </div>

        <div class="pieChart" #dexChart>
          <div class="spinner-container spinner-pie" *ngIf="isDexLoading">
            <mat-spinner class="spinner"></mat-spinner>
          </div>

          <div class="section-data" #dexChartOnly *ngIf="!isDexLoading && !isEmptyDex">
            <canvas
              baseChart
              [data]="dexChartData"
              [labels]="dexChartLabels"
              [chartType]="'doughnut'"
              [options]="dexChartOptions"
              [colors]="dexChartColors"
              style="width: 800px"
            >
            </canvas>
          </div>

          <div class="dex-table-scroll" *ngIf="!isEmptyDex && !isDexLoading">
            <table class="dex-custom-table">
              <tbody>
                <tr
                  *ngFor="let element of getFilteredDexData(); let last = last"
                  [ngClass]="{
                    'no-border-bottom': getFilteredDexData().length === 1
                  }"
                >
                  <td class="dex-color-bar-cell">
                    <div
                      class="dex-color-bar"
                      [ngStyle]="{ background: element.color }"
                    ></div>
                  </td>
                  <td class="dex-desc">{{ element.label }}</td>
                  <td class="dex-count">{{ element.total }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="no-data-dex">
          <div *ngIf="isEmptyDex" class="no-data">
            <p>{{ languageData.no_available_data }}</p>
          </div>

          <div class="no-data table" *ngIf="isEmptyDex && !isDexLoading">
            <p>{{ languageData.data_unavailable }}</p>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</div>
